{{> layout/header}}

<!--Ïª§ÎÆ§ÎãàÌã∞ ÏãúÏûë-->
<section id="section01">
    <div class="container">
        <div class="page-wrapper">
            <h3 class="page-title mb-20">
                Ïª§ÎÆ§ÎãàÌã∞ ÏÇ¨Ïó∞Î≥¥Í∏∞
            </h3>

            <div class="page-content">
                <!--Ïª§ÎÆ§ÎãàÌã∞ ÏÉÅÏÑ∏Î≥¥Í∏∞ ÏãúÏûë-->
                <div class="comm-detail">
                    <!--ÏÉÅÏÑ∏Î≥¥Í∏∞ info ÏãúÏûë-->
                    <div class="c-card">
                        <div class="c-card-body comdetail">
                            <!-- <h4 class="card-title">1</h4> -->
                            <div class="breadcrumb mb-20">
                                <a href="/">ÌôàÌôîÎ©¥</a> > <a href="/comm">Ïª§ÎÆ§ÎãàÌã∞</a> > <a href="#"
                                                                                    class="active main-color">{{comm.commDTO.category}}</a>
                            </div>
                            <h4 class="card-title">{{comm.commDTO.title}}</h4>
                            <div class="community-cartegory detail">
                                <div class="user-info">
                                    <figure><img src="{{comm.commDTO.writerProfileImage}}" alt="ÌöåÏõêÏù¥ÎØ∏ÏßÄ"></figure>
                                    <span>{{comm.commDTO.writerName}}</span><span
                                        class="time">{{comm.commDTO.timeAgo}}</span></div>
                                <div class="actions">
                                    <div class="right-actions">
                                        <button class=" defalut-btn" onclick="clip()"><i
                                                class="fa-regular fa-share-nodes"></i><span>Í≥µÏú†ÌïòÍ∏∞</span></button>
                                        <div class="dropdown">
                                            <button class="drop-toggle" id="updateButton"><i
                                                    class="fa-regular fa-ellipsis-vertical"></i>
                                            </button>
                                            <div class="dropdown-menu">
                                                <button class="dropdown-item" onclick="openUpdateForm()">ÏàòÏ†ïÌïòÍ∏∞</button>
                                                <button class="dropdown-item" onclick="deletePost()">ÏÇ≠Ï†úÌïòÍ∏∞</button>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--dropdown ÏãúÏûë..-->

                            <!--dropdown ÎÅù-->
                            <p class="card-text">{{comm.commDTO.content}}</p>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <div class="click-wrapper mb-20">
                                <button>üí¨ 2Î™ÖÏù¥ ÏßàÎ¨∏ÎãµÎ≥Ä Ï∂îÏ≤ú</button>
                                <button>‚ù§ Í≥µÍ∞ê2Í∞ú</button>
                            </div>

                        </div>
                    </div>
                    <!--ÏÉÅÏÑ∏Î≥¥Í∏∞ info ÎÅù-->

                    <!--ÎåìÍ∏Ä Ï†úÎ™© ÏãúÏûë-->
                    <hr>
                    <br>

                    {{#comm.replies}}
                        {{#userRole}}
                            <!--Ï†ÑÎ¨∏Í∞Ä ÎåìÍ∏Ä ÏãúÏûë-->
                            <div class="expert-answer mb-20">
                                <!--                                <h3 class="page-title mb-20">Ï†ÑÎ¨∏ÎãµÎ≥Ä <span class="main-color">1</span> Í∞úÍ∞Ä Îã¨Î†∏Ïñ¥Ïöî.</h3>-->
                                <div class="expert-answer-header main-background">
                                    <div class="info">
                                        <img src="/images/user.png" alt="ÏÉÅÎã¥ÏÇ¨ ÏÇ¨ÏßÑ">
                                        <div class="answer-text">
                                            <a id="expert-link" class="name"
                                               href="/client/findExpert/detail/{{writerId}}">{{name}}
                                                ÏÉÅÎã¥ÏÇ¨</a>
                                            <br>
                                            <br>
                                            <div class="details">{{level}}
                                            </div>
                                        </div>
                                    </div>
                                    <button class="defalut-btn main-background active-background"
                                            onclick="openExpert({{writerId}})">ÏÉÅÎã¥ Î∞õÏïÑÎ≥¥Í∏∞
                                    </button>
                                </div>
                                <div class="content">
                                    <br>
                                    <h5 class="page-title">ÏÜåÍ∞úÍ∏Ä</h5>
                                    <p class="detail-answer-reply mb-20">{{introduction}}</p>
                                    <br>
                                    <h5 class="page-title">üìù ÏÇ¨Î°Ä ÏöîÏïΩ</h5>
                                    <p class="detail-answer-reply mb-20">{{summary}}</p>
                                    <br>
                                    <h5 class="page-title">üí° ÏõêÏù∏ Î∂ÑÏÑù</h5>
                                    <p class="detail-answer-reply mb-20">{{causeAnalysis}}</p>
                                    <br>
                                    <h5 class="page-title">üîß ÎåÄÏ≤ò Î∞©Ïïà Ï†úÏãú</h5>
                                    <p class="detail-answer-reply mb-20">{{solution}}</p>
                                    <div class="bottom-content">
                                        <div class="click-wrapper">
                                            <button>üí¨ ÎèÑÏõÄÎèºÏöî</button>
                                        </div>
                                        <div class="actions">
                                            <div class="right-actions" style="display: flex">
                                                <button class=" defalut-btn"><i
                                                        class="fa-regular fa-share-nodes"></i><span>Í≥µÏú†ÌïòÍ∏∞</span></button>
                                                <div class="dropdown">
                                                    <button class="drop-toggle"><i
                                                            class="fa-regular fa-ellipsis-vertical"></i>
                                                    </button>
                                                    <div class="dropdown-menu">
                                                        <button class="dropdown-item">Ïã†Í≥†ÌïòÍ∏∞</button>
                                                        <button class="dropdown-item">Î∂ÅÎßàÌÅ¨ÌïòÍ∏∞</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--dropdown ÏãúÏûë..-->

                                <!--dropdown ÎÅù-->
                            </div>
                            <!--Ï†ÑÎ¨∏Í∞Ä ÎåìÍ∏Ä ÎÅù-->
                        {{/userRole}}
                        {{^userRole}}
                            <!--ÏùºÎ∞òÏù∏ ÎåìÍ∏Ä ÏãúÏûë-->
                            <div class="c-card ">
                                <div class="c-card-body detail mb-20">
                                    <div class="community-cartegory">
                                        <div class="user-info">
                                            <figure><img src="" alt="ÌöåÏõêÏù¥ÎØ∏ÏßÄ">ÏùºÎ∞òÏù∏ Ïù¥ÎØ∏ÏßÄ</figure>
                                            <span>{{name}}</span>
                                        </div>
                                    </div>
                                    <p class="card-text mb-20">{{content}}</p>

                                    <div class="bottom-content">
                                        {{#sessionUser}}
                                            <div class="click-wrapper">
                                                <button id="replyDeleteButton"
                                                        onclick="deleteReply({{writerId}}, {{replyId}})">
                                                    ÏÇ≠Ï†úÌïòÍ∏∞
                                                </button>
                                            </div>
                                        {{/sessionUser}}
                                    </div>
                                </div>
                            </div>
                            <!--ÏùºÎ∞òÏù∏ ÎåìÍ∏Ä ÎÅù-->
                        {{/userRole}}
                    {{/comm.replies}}

                    <div class="comment-section mb-50">
                        <input type="text" placeholder="Îî∞ÎúªÌïú ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî" name="content" id="content">
                        {{^sessionUser}}
                            <button class="main-background defalut-btn">Í≤åÏãú</button>
                        {{/sessionUser}}
                        {{#sessionUser}}
                            {{#isExpert}}
                                <button class="main-background defalut-btn"
                                        onclick="openNewWindow({{comm.commDTO.id}})">
                                    Ï†ÑÎ¨∏Í∞Ä ÎåìÍ∏Ä
                                    Í≤åÏãú
                                </button>
                            {{/isExpert}}
                            {{#isClient}}
                                <button class="main-background defalut-btn"
                                        onclick="clientReplyAction({{comm.commDTO.id}})">Í≤åÏãú
                                </button>
                            {{/isClient}}
                        {{/sessionUser}}
                    </div>

                    <hr>
                    <script src="../js/communutiyDetailExpert.js"></script>
                    <!--Ï†ÑÎ¨∏Í∞Ä ÎåìÍ∏Ä ÎÅù-->
                    <!--ÎåìÍ∏Ä ÏÑπÏÖò ÏãúÏûë-->
                    <!--Í∞ôÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Îã§Î•∏ Í∏Ä ÏÇ¥Ìé¥Î≥¥Í∏∞ ÏãúÏûë-->
                    <br>
                    <h3 class="page-title mb-20">{{comm.commDTO.category}}Ïùò Îã§Î•∏ Í∏Ä ÏÇ¥Ìé¥Î≥¥Í∏∞</h3>
                    <!-- Îã§Î•∏ Í∏Ä -->
                    {{#comm.relatedComms}}
                        <div class="c-card">
                            <div class="c-card-body detail">
                                <a href="/comm-detail/{{id}}">
                                    <h4 class="card-title mb-10">{{title}}</h4>
                                    <div class="community-cartegory">
                                        <div class="category main-color">{{category}}</div>
                                        <div class="user-info">
                                            <figure><img src="{{writerProfileImage}}" alt="ÌöåÏõêÏù¥ÎØ∏ÏßÄ"></figure>
                                            <span>{{writerName}}</span>
                                        </div>
                                    </div>
                                    <p class="card-text mb-20">{{content}}</p>
                                </a>
                                <div class="link-wrapper">
<!--                                    <a href="#" class="card-link like">‚ù§<em class="count">1</em></a>-->
                                    <a href="/comm-detail/{{id}}" class="card-link reply">üíå<em class="count">2</em></a>
                                </div>
                                {{#expertReplies}}
                                    <div class="expert-reply">
                                        <div class="expert-reply-info mb-10">
                                            <figure><img src="{{writerProfileImage}}" alt="Ï†ÑÎ¨∏Í∞Ä Ïù¥ÎØ∏ÏßÄÍ∞Ä Îì§Ïñ¥Í∞à ÏûêÎ¶¨"></figure>
                                            <span class="expert-reply-name active-color">{{writerName}}ÎãòÏùò Ï†ÑÎ¨∏ÎãµÎ≥Ä</span>
                                        </div>
                                        <p class="reply-content">
                                            {{solution}}
                                        </p>
                                    </div>
                                {{/expertReplies}}
                            </div>

                        </div>
                    {{/comm.relatedComms}}
                </div>
                <!--ÎãµÎ≥Ä Ï§ë Ï†ÑÎ¨∏Í∞ÄÍ∞Ä Î¶¨Ìîå Îã¨ÏïÑÏ§Ä Í≤É ÏãúÏûë-->
            </div>
            <!--Ïª§ÎÆ§ÎãàÌã∞ ÏÉÅÏÑ∏Î≥¥Í∏∞ ÎÅù-->
        </div>
    </div>
    </div>
</section>

<script>
    $(document).ready(function () {

        // ÎìúÎ°≠Îã§Ïö¥ Î∞ïÏä§
        $('.dropdown').click(function () {
            $(this).find('.dropdown-menu').toggleClass('show');

        });

        // Ìï¥Îãπ Ï£ºÏÜåÎßÅÌÅ¨ Ï†ÄÏû•
        function clip() {
            var url = window.location.href; // Ï£ºÏÜåÏ∞ΩÏùò URLÏùÑ Í∞ÄÏ†∏Ïò¥
            var textarea = document.createElement("textarea");
            document.body.appendChild(textarea);
            textarea.value = url;
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            alert("ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
            console.log(url);
        };
    });

    // Ïú†Ï†Ä ÏïÑÏù¥Îîî Í≤ÄÏÇ¨Ìï¥ÏÑú ÏàòÏ†ï ÏÇ≠Ï†ú Î≤ÑÌäº Ïà®Í∏∞Í∏∞
    $(document).ready(function () {
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§ÌñâÎêòÎäî ÏΩîÎìú
        checkPermission();
    });

    // Ï†ÑÎ¨∏Í∞Ä ÎåìÍ∏Ä Îã¨Í∏∞ Ï∞Ω Ïó¥Í∏∞
    function openNewWindow(id) {
        fetch(`/api/comm-detail/${id}/has-expert-reply`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        alert('Ïù¥ÎØ∏ Ï†ÑÎ¨∏ÎãµÎ≥ÄÏù¥ Îã¨Î¶∞ Í∏ÄÏûÖÎãàÎã§.');
                    } else {
                        var url = "/expert/reply?id=" + id;
                        var windowFeatures = "width=600, height=900, scrollbars=yes";
                        window.open(url, "_blank", windowFeatures);
                    }
                })
                .catch(error => {
                    console.error('Error checking expert reply:', error);
                    alert('Ï†ÑÎ¨∏ÎãµÎ≥ÄÏùÑ ÌôïÏù∏ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                });
    }

    // ÏùºÎ∞òÏù∏ ÎåìÍ∏Ä Îã¨Í∏∞
    function clientReplyAction(id) {
        const content = document.getElementById('content').value;

        if (content === "") {
            alert("ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
            return; // ÎÇ¥Ïö©Ïù¥ ÏóÜÏúºÎ©¥ Ìï®Ïàò Ïã§Ìñâ Ï§ëÎã®
        }

        const newReply = {
            id: id,
            content: content
        };

        fetch('/client-reply/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(newReply),
        })
                .then(response => {
                    if (response.ok) {
                        alert('ÎåìÍ∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                        window.location.reload();
                    } else {
                        alert('ÎåìÍ∏Ä Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    }
                })
                .catch(error => {
                    console.error('Error posting client reply:', error);
                    alert('ÎåìÍ∏Ä Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                });
    }

    // Í∏Ä ÏàòÏ†ï Ìèº Î≥¥Ïù¥Í∏∞
    function openUpdateForm() {
        const title = "{{comm.commDTO.title}}";
        const content = "{{comm.commDTO.content}}";
        const category = "{{comm.commDTO.category}}";

        const categories = ["ÏùºÎ∞òÍ≥†ÎØº", "Ï∑®ÏóÖ/ÏßÑÎ°ú", "ÏßÅÏû•", "Ïó∞Ïï†", "ÎåÄÏù∏Í¥ÄÍ≥Ñ", "Ï§ëÎèÖ/ÏßëÏ∞©", "Í∏àÏ†Ñ/ÏÇ¨ÏóÖ"];

        // Í∏∞Ï°¥Ïùò Ïπ¥ÌÖåÍ≥†Î¶¨ÏôÄ ÎèôÏùºÌïú Í≤ΩÏö∞Î•º Ï†úÏô∏ÌïòÍ≥† ÏòµÏÖòÏùÑ ÏÉùÏÑ±
        const categoryOptions = categories.map(cat => {
            if (cat === category) {
                return `<option value="${cat}" selected>${cat}</option>`;
            } else {
                return `<option value="${cat}">${cat}</option>`;
            }
        }).join('');

        const updateForm = `
        <form id="updateForm" onsubmit="updatePost(event)">
            <input type="text" id="updateTitle" value="${title}" placeholder="Ï†úÎ™©">
            <textarea id="updateContent" placeholder="ÎÇ¥Ïö©">${content}</textarea>
            <select id="updateCategory">
                ${categoryOptions}
            </select>
            <button type="submit" class="main-background defalut-btn">ÏàòÏ†ï ÏôÑÎ£å</button>
        </form>
    `;

        $(".comdetail").html(updateForm);
    }

    // ÏàòÏ†ï ÏôÑÎ£å ÏÑúÎ≤ÑÎ°ú Î≥¥ÎÇ¥Í∏∞
    function updatePost(event) {
        event.preventDefault(); // ÌèºÏùò Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ

        const id = {{comm.commDTO.id}}; // ÏàòÏ†ïÌï† Í∏ÄÏùò ID
        const updatedTitle = document.getElementById('updateTitle').value;
        const updatedContent = document.getElementById('updateContent').value;
        const updatedCategory = document.getElementById('updateCategory').value;

        const updatedPost = {
            id: id,
            title: updatedTitle,
            content: updatedContent,
            category: updatedCategory
        };

        fetch('/comm/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedPost),
        })
                .then(response => {
                    if (response.ok) {
                        alert('Í∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                        window.location.reload(); // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
                    } else {
                        alert('Í∏Ä ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    }
                })
                .catch(error => {
                    console.error('Error updating post:', error);
                    alert('Í∏Ä ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                });
    }

    // Í≤åÏãúÍ∏Ä ÏÇ≠Ï†úÌïòÍ∏∞
    function deletePost() {
        const commId = "{{comm.commDTO.id}}"; // ÏÇ≠Ï†úÌï† Í∏ÄÏùò ID
        if (confirm("Ï†ïÎßêÎ°ú Ïù¥ Í∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            // ÌôïÏù∏ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå ÏÇ≠Ï†ú ÏöîÏ≤≠ÏùÑ ÏÑúÎ≤ÑÏóê Î≥¥ÎÉÑ
            fetch(`/comm/delete/${commId}`, {
                method: 'DELETE',
            })
                    .then(response => {
                        if (response.ok) {
                            alert('Í∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                            window.location.href = '/comm';
                        } else {
                            alert('Í∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting post:', error);
                        alert('Í∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    });
        }
    }

    // ÎåìÍ∏Ä ÏÇ≠Ï†úÌïòÍ∏∞
    function deleteReply(writerId, replyId) {
        if (confirm("Ï†ïÎßêÎ°ú Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            // ÏÇ≠Ï†ú ÏöîÏ≤≠ Ïãú ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞
            const requestData = {
                writerId: parseInt(writerId), // writerIdÎ•º Ïà´ÏûêÌòïÏúºÎ°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
                replyId: parseInt(replyId) // replyIdÎ•º Ïà´ÏûêÌòïÏúºÎ°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
            };

            fetch(`/reply/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData) // JSON ÌòïÏãùÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
            })
                    .then(response => {
                        if (response.ok) {
                            alert('ÎåìÍ∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                            window.location.reload(); // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
                        } else {
                            return response.text().then(errorMsg => {
                                if (errorMsg === "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.") {
                                    alert(errorMsg); // Î°úÍ∑∏Ïù∏ ÌïÑÏöî Î©îÏãúÏßÄ
                                } else if (errorMsg === "ÏûêÏã†Ïù¥ ÏûëÏÑ±Ìïú ÎåìÍ∏ÄÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.") {
                                    alert(errorMsg); // ÏûêÏã†Ïùò ÎåìÍ∏ÄÏù¥ ÏïÑÎãå Í≤ΩÏö∞ Î©îÏãúÏßÄ
                                } else {
                                    alert(`ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®: ${errorMsg}`); // Í∏∞ÌÉÄ Ïã§Ìå® Î©îÏãúÏßÄ
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting reply:', error);
                        alert('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    });
        } else {
            alert('ÎåìÍ∏Ä ÏÇ≠Ï†úÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
        }
    }

    // ÏÉÅÎã¥ Î∞õÏïÑÎ≥¥Í∏∞ Î≤ÑÌäº
    function openExpert(writerId) {
        const expertDetailUrl = `/client/findExpert/detail/${writerId}`;
        window.location.href = expertDetailUrl;
    }

</script>
<!--Ïª®ÌÖêÏ∏† ÎÅù-->
</div>
<!--Ïª§ÎÆ§ÎãàÌã∞ ÎÅù-->
{{> layout/footer}}

