{{> layout/header}}

<!--Ïª§ÎÆ§ÎãàÌã∞ ÏãúÏûë-->
<section id="section01">
    <div class="container">
        <div class="page-wrapper">
            <h3 class="page-title mb-20">
                Ïª§ÎÆ§ÎãàÌã∞ ÏÇ¨Ïó∞Î≥¥Í∏∞
            </h3>
            <div class="page-content">
                <div class="comm">
                    <div class="comm-nav">
                        <div class="navbar navbar-expand-lg navbar-light bg-light">
                            <div class="container-fluid">
                                <a class="navbar-brand" href=/comm>Î™®Îì† ÏÇ¨Ïó∞</a>
                                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
                                        aria-expanded="false"
                                        aria-label="Toggle navigation">
                                    <span class="navbar-toggler-icon"></span>
                                </button>
                                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                                    <ul class="navbar-nav">
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="GENERAL_CONCERNS">ÏùºÎ∞òÍ≥†ÎØº</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="CAREER_JOBS">Ï∑®ÏóÖ/ÏßÑÎ°ú</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="WORK_LIFE">ÏßÅÏû•</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="RELATIONSHIPS">Ïó∞Ïï†</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="SOCIAL_INTERACTIONS">ÎåÄÏù∏Í¥ÄÍ≥Ñ</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="ADDICTION_OBSESSION">Ï§ëÎèÖ/ÏßëÏ∞©</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-category="FINANCE_BUSINESS">Í∏àÏ†Ñ/ÏÇ¨ÏóÖ</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--ÌïÑÌÑ∞ ÏãúÏûë-->
                    <div class="comm-filter mb-20">
                        <button class="active black-background">‚ú®ÏµúÏã†Ïàú</button>
                        <button>üë©‚Äç‚öïÔ∏èÏ†ÑÎ¨∏ÎãµÎ≥Ä</button>
                        <button>üòçÍ≥µÍ∞êÏàú</button>
                        {{#sessionUser}}
                            <button id="writeButton" onclick="openWrite()">Í∏ÄÏì∞Í∏∞</button>
                        {{/sessionUser}}
                    </div>
                    <!--ÌïÑÌÑ∞ ÎÅù-->
                    <!--Ïª®ÌÖêÏ∏† ÏãúÏûë-->
                    <div class="c-card" id="comm-posts-container">
                        {{!-- Ï¥àÍ∏∞ ÌéòÏù¥ÏßÄ Î°úÎìú --}}
                        {{#allCommsWithReplyList.comms}}
                            <div class="c-card-body">
                                <a href="/comm-detail/{{id}}">
                                    <h4 class="card-title mb-10">{{title}}</h4>
                                    <div class="community-cartegory">
                                        <div class="category main-color">{{category}}</div>
                                        <div class="user-info">
                                            <figure><img src="{{writerImage}}" alt="ÌöåÏõêÏù¥ÎØ∏ÏßÄ"></figure>
                                            <span>{{writerName}}</span>
                                        </div>
                                    </div>
                                    <p class="card-text mb-20">{{content}}</p>
                                </a>
                                <div class="link-wrapper">
                                    <a href="#" class="card-link reply"> <span>
                    <i class="far fa-comment"></i>
                    <span>0</span>
                </span><em class="count">{{replies}}</em></a>
                                </div>
                                {{#expertReplies}}
                                    {{#userRole}}
                                        <div class="expert-reply">
                                            <div class="expert-reply-info mb-10">
                                                <figure><img src="/images/user.png" alt={{profileImage}}></figure>
                                                <span class="expert-reply-name active-color">{{expertName}}
                                                    ÎãòÏùò Ï†ÑÎ¨∏ÎãµÎ≥Ä</span>
                                            </div>
                                            <p class="reply-content">
                                                {{solution}}
                                            </p>
                                        </div>
                                    {{/userRole}}
                                {{/expertReplies}}
                            </div>
                        {{/allCommsWithReplyList.comms}}
                    </div>
                </div>
                <div class="comm-pagination d-flex ">
                    <ul class="pagination" id="pagination-container">
                        {{#allCommsWithReplyList.hasPrevious}}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{allCommsWithReplyList.previousPage}}">Previous</a>
                            </li>
                        {{/allCommsWithReplyList.hasPrevious}}
                        {{#eachPage}}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{this}}">{{this}}</a>
                            </li>
                        {{/eachPage}}
                        {{#allCommsWithReplyList.hasNext}}
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="{{allCommsWithReplyList.nextPage}}">Next</a>
                            </li>
                        {{/allCommsWithReplyList.hasNext}}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    $(document).ready(function () {
        function loadPage(page, size, category) {
            $.ajax({
                url: '/api/comm',
                method: 'GET',
                data: {
                    page: page,
                    size: size,
                    category: category
                },
                success: function (data) {
                    updatePageContent(data);
                },
                error: function (xhr, status, error) {
                    console.error('ÌéòÏù¥ÏßÄ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                }
            });
        }

        function updatePageContent(data) {
            const $commPostsContainer = $('#comm-posts-container');
            $commPostsContainer.empty();
            data.comms.forEach(comm => {
                const commElement = `
                    <div class="c-card-body">
                        <a href="/comm-detail/${comm.id}">
                            <h4 class="card-title mb-10">${comm.title}</h4>
                            <div class="community-cartegory">
                                <div class="category main-color">${comm.category}</div>
                                <div class="user-info">
                                    <figure><img src="${comm.writerImage}" alt="ÌöåÏõêÏù¥ÎØ∏ÏßÄ"></figure>
                                    <span>${comm.writerName}</span>
                                </div>
                            </div>
                            <p class="card-text mb-20">${comm.content}</p>
                        </a>
                        <div class="link-wrapper">
                            <span class="post-meta">
                            <a href="/comm-detail/${comm.id}" class="card-link reply"> <span>
                    <i class="far fa-comment" style=" color: #ff6b6b;"></i>
                    <span>${comm.replies}</span>
                </span><em class="count"></em></a>
                        </div>
                        ${comm.expertReplies.map(reply => `
                            ${reply.userRole ? `
                                <div class="expert-reply">
                                    <div class="expert-reply-info mb-10">
                                        <figure><img src="/images/user.png" alt="${reply.profileImage}"></figure>
                                        <span class="expert-reply-name active-color">${reply.expertName} ÎãòÏùò Ï†ÑÎ¨∏ÎãµÎ≥Ä</span>
                                    </div>
                                    <p class="reply-content">${reply.solution}</p>
                                </div>
                            ` : ''}
                        `).join('')}
                    </div>
                `;
                $commPostsContainer.append(commElement);
            });

            const $paginationContainer = $('#pagination-container');
            $paginationContainer.empty();
            if (data.hasPrevious) {
                $paginationContainer.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${data.previousPage}">Previous</a>
                    </li>
                `);
            }
            for (let i = data.startPage; i <= data.endPage; i++) {
                $paginationContainer.append(`
                    <li class="page-item ${i === data.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                    </li>
                `);
            }
            if (data.hasNext) {
                $paginationContainer.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${data.nextPage}">Next</a>
                    </li>
                `);
            }
        }

        $(document).on('click', '.pagination a', function (e) {
            e.preventDefault();
            const page = $(this).data('page');
            const category = $('.comm-nav .nav-link.active').data('category');
            loadPage(page, 9, category);
        });

        $(document).on('click', '.comm-nav .nav-link', function (e) {
            e.preventDefault();
            $('.comm-nav .nav-link').removeClass('active');
            $(this).addClass('active');
            const category = $(this).data('category');
            loadPage(0, 9, category);
        });

        loadPage(0, 9, null);
    });

    function openWrite() {
        window.location.href = '/comm/write';
    }
</script>

{{> layout/footer}}
